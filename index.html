<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>VAA Chatbot Embed</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* reset + font */
    * { box-sizing:border-box; margin:0; padding:0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    html,body { height:100%; background: transparent; overflow: hidden; }

    /* Floating toggle button (visible on host site) */
    .vaa-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      background: linear-gradient(135deg,#7AD67A,#37C2A0);
      color: #fff;
      border: none;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 8px 22px rgba(0,0,0,0.25);
      font-size: 26px;
      z-index: 9999;
      cursor: pointer;
    }

    /* Chat container (hidden initially) */
    .chat-container {
      position: fixed;
      bottom: 96px; /* above toggle */
      right: 20px;
      width: 360px;
      height: 500px;
      max-width: calc(100% - 40px);
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 34px rgba(0,0,0,0.22);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 9998;
      transform: translateY(10px);
      opacity: 0;
      pointer-events: none;
      transition: all 260ms ease;
    }

    .chat-container.active {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }

    .chat-header {
      background: linear-gradient(135deg,#7AD67A,#37C2A0);
      color: #fff;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .chat-header h3 { font-size: 15px; display:flex; gap:8px; align-items:center; margin:0; }
    .chat-header button.close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }

    .messages-container {
      flex:1;
      padding: 12px;
      overflow-y:auto;
      background:#f7f9fc;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .message { max-width:80%; padding:10px 14px; border-radius:12px; font-size:14px; word-wrap:break-word; }
    .bot-message { background:#e7fff0; color:#222; align-self:flex-start; border:1px solid #c3f0d2; }
    .user-message { background: linear-gradient(135deg,#7AD67A,#37C2A0); color:#fff; align-self:flex-end; }

    .input-area {
      display:flex;
      gap:8px;
      padding:10px;
      border-top:1px solid #e6e6e6;
      background:#fff;
      align-items:center;
    }
    .input-area input[type="text"] {
      flex:1;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:20px;
      font-size:14px;
      outline:none;
    }
    .send-btn {
      width:44px;
      height:44px;
      border-radius:50%;
      border:none;
      background: linear-gradient(135deg,#7AD67A,#37C2A0);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    /* typing indicator */
    .typing { display:flex; align-items:center; gap:6px; padding:8px 12px; background:#e7fff0; border-radius:12px; border:1px solid #c3f0d2; font-size:13px; align-self:flex-start; }

    /* small screen adjustments */
    @media (max-width:420px){
      .chat-container { right: 10px; bottom: 84px; width: calc(100% - 20px); height: 62vh; }
      .vaa-toggle { right: 14px; bottom: 14px; width:56px; height:56px; }
    }
  </style>
</head>
<body>
  <!-- Toggle visible when embedded on host site -->
  <button class="vaa-toggle" id="vaaToggle" title="Open VAA Chat">
    <i class="fas fa-comment-dots"></i>
  </button>

  <!-- Chat UI (hidden by default) -->
  <div class="chat-container" id="chatContainer" aria-hidden="true" role="region" aria-label="VAA Assistant">
    <div class="chat-header">
      <h3><i class="fas fa-robot"></i> VAA Assistant</h3>
      <button class="close" id="closeChat" aria-label="Close chat"><i class="fas fa-times"></i></button>
    </div>

    <div class="messages-container" id="messagesContainer" role="log" aria-live="polite">
      <div class="message bot-message">ðŸ‘‹ Welcome to VAA Chat! How can I assist you today?</div>
    </div>

    <div class="input-area">
      <input id="userInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendBtn" class="send-btn" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <script>
    // --- Config (replace key/ids if needed) ---
    const LYZR_API_KEY = "sk-default-phYvRzQpPLvim4wIqsurX37KzYBOwKhY";
    const AGENT_ID = "6901a882e26dd0e036848c05";
    const SESSION_ID = "6901a882e26dd0e036848c05-evuz3e1t18c";
    const LYZR_API_URL = "https://agent-prod.studio.lyzr.ai/v3/inference/chat/";

    // --- Elements ---
    const toggle = document.getElementById('vaaToggle');
    const chat = document.getElementById('chatContainer');
    const closeBtn = document.getElementById('closeChat');
    const messagesContainer = document.getElementById('messagesContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    // --- Toggle open/close ---
    function openChat() {
      chat.classList.add('active');
      chat.setAttribute('aria-hidden','false');
      userInput.focus();
    }
    function closeChatFn() {
      chat.classList.remove('active');
      chat.setAttribute('aria-hidden','true');
    }

    toggle.addEventListener('click', () => {
      if (chat.classList.contains('active')) closeChatFn();
      else openChat();
    });
    closeBtn.addEventListener('click', closeChatFn);

    // --- Messaging helpers ---
    function addMessage(text, sender='bot') {
      const div = document.createElement('div');
      div.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
      // basic markdown-like formatting (bold/italic) and line breaks
      const html = String(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
      div.innerHTML = html;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return div;
    }

    function showTyping(text = 'Thinking...') {
      removeTyping();
      const t = document.createElement('div');
      t.className = 'typing';
      t.id = 'typingIndicator';
      t.innerHTML = `<span>${text}</span><div style="width:8px;height:8px;border-radius:50%;background:#666;animation:typing 1.4s infinite ease-in-out;margin-left:8px"></div>`;
      messagesContainer.appendChild(t);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    function removeTyping() {
      const t = document.getElementById('typingIndicator');
      if (t) t.remove();
    }

    // --- Send message to backend ---
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      userInput.value = '';
      showTyping('Searching...');

      const payload = {
        user_id: "vaa-user@test.com",
        agent_id: AGENT_ID,
        session_id: SESSION_ID,
        message: message
      };

      try {
        const res = await fetch(LYZR_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': LYZR_API_KEY
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          removeTyping();
          addMessage('âš ï¸ Server error. Please try again later.', 'bot');
          return;
        }

        const data = await res.json();
        removeTyping();
        const botText = data && (data.response || data.result || data.answer) ? (data.response || data.result || data.answer) : "ðŸ¤– Sorry, I didnâ€™t catch that.";
        addMessage(botText, 'bot');
      } catch (err) {
        removeTyping();
        addMessage('âš ï¸ Connection error. Please try again.', 'bot');
        console.error('chat error', err);
      }
    }

    // --- Events ---
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    // Optional: open chat automatically on first load
    // openChat();

    // Accessibility: focus management when chat opens
    chat.addEventListener('transitionend', () => {
      if (chat.classList.contains('active')) userInput.focus();
    });
  </script>
</body>
</html>
